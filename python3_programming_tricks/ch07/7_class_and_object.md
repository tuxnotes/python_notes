
# 7 类与对相关相关话题

## 7.1 如何派生内置不可变类型并修改其实例化行为

**实际案例**

比如我们想自定义一种新类型的元组，对于传入的可迭代对象，我们只保留其中int类型且值大于0的元素，例如：

IntTuple([1, -1, 'abc', 6, ['x','y'],3]) => (1,6,3)

如何继承内置tuple实现IntTuple?


**解决方案**

继承内置tuple,并实现\_\_new\_\_.在其中修改实例化行为

## 7.2 如何为创建大量实例节省内存

**实际案例**

在某网络游戏中，定义了玩家类Player(id, name, level, ...).每有一个在线玩家，在服务器程序内则有一个Player实例。
当在线人数很多时，将产生大量实例。(如百万级)
如何降低这些大量实例的内存开销？

**解决方案**

定义类的\_\_slots\_\_属性，声明实例有哪些属性(关闭动态绑定)

## 7.3 如何让对象支持上下文管理

**实际案例**

我们实现了一个telnet客户端的类TelnetClient，调用实例的connect(),login(),interact()方法启动客户端与服务器交互，交互完毕后需要调用cleanup()方法，关闭已连接的socket，以及操作历史记录写入文件并关闭。
能否让TelnetClient的实例支持上下文管理协议，从而替代手工调用cennect(), cleanup()方法。

**解决方案**

实现上下文管理协议，即实现类的\_\_enter\_\_,\_\_exit\_\_方法
它们分别在with开始和结束时被调用

## 7.4 如何创建可管理的对象属性

**实际案例**

在面向对象编程中，我们把方法(函数)看做对象的接口。直接访问对象的属性可能是不安全的，或设计上不够灵活。但是使用调用方法在形式上不如访问属性简洁。

circle.get_radius()
circle.set_radius(5.0) # 繁

circle.radius
circle.radius = 5.0 # 简

能否在形式上是属性访问，但实际上内部调用方法

**解决方案**

使用property函数为类创建可管理属性，fget/fset/fdel

## 7.5 如何让类支持比较操作

**实际案例**

有时我们希望自定义类的实例之间可以使用<,<=,>,>=,==,!=符号进行比较，我们自定义比较的行为。例如，有一个矩形的类，比较两个矩形的实例时，比较的是它们的面积。

class Rectangle:
    def __init__(self, w, h):
        self.w = w
        self.h = h

    def area(self):
        return self.w * self.h

        
rect1 = Rectangle(5,3)        
rect2 = Rectangle(4,4)        
rect1 > rect2   # => rect1.area() > rect2.area()

**解决方案**

比较符号运算符重载，需要实现一下方法：
\_\_lt\_\_,\_\_le\_\_,\_\_gt\_\_,\_\_ge\_\_,\_\_eq\_\_,\_\_ne\_\_,

使用标准库的下的functools下的类装饰器total_ordering可以简化此过程

## 7.6 如何使用面舒服对实例属性做类型检查

**实际案例**

某项目中，我们实现了一些类，并希望能想静态类型语言那样(C,C++,Java,编译阶段进行类型检查)对它们的实例属性做类型检查。

p = Person()
p.name = 'Bob' # 必须是str
p.age = 18 # 必须是int
p.height = 1.83 # 必须是float

要求：

1. 可对实例属性指定类型
2. 富裕不正确类型时抛出异常

**解决方案**

使用描述符来实现需要类型检查的属性：分别实现
\_\_get\_\_,\_\_set\_\_,\_\_delete\_\_,在\_\_set\_\_内使用isinstance函数做类型检查。

## 7.7 如何在环状数据结构中管理内存

**实际案例**

在Python中，垃圾回收器通过引用计数来回收垃圾对象，但某些环状数据结构(树，图...)，存在对象间的循环引用，比如树的父节点引用子节点，子节点也同时引用父节点，此时同时del掉引用父子节点，两个对象不能被立即收回。
如何解决此类的内存管理问题？

**解决方案**

使用标准库weakref.ref，它可以创建一种能访问对象但不增加引用计数的对象.


## 7.8 如何通过方法名字的字符串调用方法

**实际案例**

某项目中，我们的代码使用了三个不同库中的图形类：

    Circle, Triangle, Rectangle

它们都有一个获取图形面积的接口(方法),但接口名字不同，我们可以实现一个同意的获取面积的函数，使用每种方法名进行尝试，调用相应类的接口。

**解决方案**

方法一：使用内置函数getattr，通过名字获取方法对象，然后调用

方法二：使用标准库operator下的methdcaller函数调用
